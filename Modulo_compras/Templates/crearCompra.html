 {%extends 'Menu_Usuario.html'%} {% block head %} {% load static %}

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Compra</title>
    <link rel="stylesheet" href="/static/Modulo_compras/css/style.css">
    <link rel="icon" href="/static/Proyecto_Ekiria/Img/Logo Ekiria.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vast+Shadow&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="sweetalert2.min.css">
    <script src="/static/bootstrap/js/bootstrap.js"></script>
    <!--  Datatables  -->
    <link rel="stylesheet" type="text/css" href="{%static 'Plugins/DataTables/jquery.dataTables.min.css' %}" />

    <!--  extension responsive  -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.dataTables.min.css">


</head>
{% endblock head %} {% block Contenido %}

<button class="btn btn-link col-md-1" style="text-decoration: none;"><a style="text-decoration: none; font-size: 24px; "  href="{%url 'listarcompra'%}">Volver</a></button>
<p class="container alert-warning pAlertContenedor" id="pAlertContenedor">Este bloque ya se ha puesto <i class="mdi mdi-close" style="float: right!important; font-size: 24px; margin-top: -6px;cursor: pointer;" onclick="let p = document.getElementById('pAlertContenedor')
p.style.display='none'"></i></p>
<div class="container GridProductos" style="margin-top: 0px!important;">
    <div id="labelTp">
        <form class="fomularioProducto" id="fomularioProducto" action="{%url 'crearcompra'%}" method="post">
            {% csrf_token %}
            <h1 class="TituloCompra">Crear Compra</h1>
            <div class="Alerta" id="Alerta">
                <b>Arastra aquí los productos</b>
            </div>
            <table class="table">
                <tbody id="DropCompra" style="width: 100%;">
                </tbody>
            </table>
            <div class="gridFootCompra">
                <div class="alert alert-dark" style="display:none; text-align: start;padding: 0.4rem;
                height: 40px;" id="contenTotal">Total: <b id="TotalNeto"></b></div>
                <button type="button" class="btn btn-success BottonCompra" style="float: right;" onclick="CrearCompra()">Crear</button>
            </div>
        </form>
    </div>
    <div class="tipo_productoroductos">
        <a href="{%url 'crearprod'%}"><i class="mdi mdi-plus-circle-outline" style="cursor:pointer;"></i></a>
        <h1>Productos</h1>
        <hr>
        <table id="Tabletipo_producto" class="table display nowrap" cellspacing="0" width="100">
            <thead>
                <tr class="table-dark">
                    <td class="estado ocultoSi" style="display: none !important;">Num</td>
                    <td scope="col">Nombre</td>
                    <td scope="col">Proveedor</td>
                    <td class="estado ocultoSi" style="display: none !important;">Tipo de producto</td>
                </tr>
            </thead>
            <tbody id="tbody">
                {% for producto in productos %}
                <tr class="table-light focus parent" draggable="true" id="caja{{producto.pk}}">

                    <td class="estado" style="display: none !important;" id="prodPk{{producto.pk}}" class="prodId">{{producto.pk}}</td>
                    <td scope="row">{{producto.nombre}}</td>
                    <td scope="col"> {% for proveedor in proveedor %} {% if proveedor.pk == producto.proveedor_id %} {{proveedor.nombre}} {% endif %} {% endfor %}
                    </td>
                    <td class="estado ocultoSi" style="display: none !important;" scope="col">{% for tipo in Tipo %} {% if tipo.pk == producto.tipo_producto_id%} {{tipo.nombre}} {% endif %} {% endfor %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Etiquetas que se agregan a los productos -->
<table>
    <tbody style="display: none;">
        <td id="cantidad0"><input class="form-control cantidad" id="inputcantidad0" type="number" placeholder="Cantidad"></td>
        <td id="precio0"><input class="form-control precio" id="inputprecio0" type="number" placeholder="Precio de unidad"></td>
        <td id="remove0" class="closeButton"><button type="button" class="btn btn-danger" style="padding:0px 0.35rem;"><i class="mdi mdi-trash-can-outline"style="font-size:24px;"></i><b style="display: none;">0</b></button></td>
    </tbody>
</table>
<form id="CrearHistorial" action="{%url 'CrearHistorial'%}" method="post">{% csrf_token %}</form>
<!--  -->

{% endblock Contenido %} {% block modal %} {% endblock modal%} {%block scripts%}
<script>
    var cantidadProductos = 0
</script>
{% for producto in productos %}
<script>
    cantidadProductos = '{{ forloop.counter }} '
</script>{% endfor %}
<script>
    // Ajax compra
    function CrearCompra() {
        DatosCompra = []
        Productos = []
        let identi = 0
        let Padre = document.querySelectorAll('.parent')
        for (let i = 0; i < Padre.length - cantidadProductos; i++) {
            identi = Padre[i].id.substring(4)
            let tr = document.getElementById('caja' + identi)
            let Id = tr.childNodes[1].innerHTML
            let Cantidad = tr.childNodes[9].firstChild.value
            let Precio = tr.childNodes[10].firstChild.value
            let productos = tr.childNodes[3].innerHTML
            Productos.push(productos)
            DatosCompra.push({
                'Id': Id,
                "Cantidad": Cantidad,
                "Precio": Precio
            })
        }
        let token = $("#fomularioProducto").find('input[name=csrfmiddlewaretoken]').val()
        swal({
            title: "¿Estás seguro?",
            text: "Se Creara una compra con estos productos: \n" + Productos,
            icon: "warning",
            dangerMode: true,
            buttons: {
                confirm: {
                    text: 'Confirmar',
                    className: 'btn-success'
                },
                cancel: 'Cancelar'
            },
        }).then((willDelete) => {
            if (willDelete) {
                swal("¡OK¡ Se ha enviado la información correctamente", {
                    icon: "success",
                }).then(function() {
                    $.ajax({
                        data: {
                            'Datos[]': JSON.stringify(DatosCompra),
                            "csrfmiddlewaretoken": token
                        },
                        url: $("#fomularioProducto").attr('action'),
                        type: $("#fomularioProducto").attr('method'),
                        success: function(data) {
                            let timerInterval
                            Swal.fire({
                                icon: 'success',
                                title: 'Se ha creado la compra correctamente',
                                html: 'Con valor de: ' + data['total'],
                                timer: 6000,
                                timerProgressBar: true,
                                willClose: () => {
                                    $.ajax({
                                        data: {
                                            'historial[]': JSON.stringify(data['historial']),
                                            "csrfmiddlewaretoken": $("#CrearHistorial").find('input[name=csrfmiddlewaretoken]').val()
                                        },
                                        url: $("#CrearHistorial").attr('action'),
                                        type: $("#CrearHistorial").attr('method'),
                                        success: function(data) {
                                            window.location.href = "../listarcompra/";
                                        },
                                        error: function(error) {
                                            Error = error['responseJSON']
                                            Swal.fire({
                                                icon: 'info',
                                                title: 'Atención.',
                                                text: Error['error'] + '.',
                                            })
                                        }
                                    })
                                }
                            })
                        },
                        error: function(error) {
                            Error = error['responseJSON']
                            Swal.fire({
                                icon: 'info',
                                title: 'Atención.',
                                text: Error['error'] + '.',
                            })
                        }
                    });
                });
            } else {
                swal("¡OK! Puedes seguir modificando tu compra");

            }
        });
        return false;
    }
</script>
<!--   Datatables-->
<script type="text/javascript" src="{%static 'Plugins/DataTables/jquery.dataTables.min.js' %}"></script>
<!-- extension responsive -->
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="/static/Modulo_compras/js/js.js"></script>
<script src="/static/Modulo_compras/js/CrearCompra.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>{%endblock scripts%}


</html>